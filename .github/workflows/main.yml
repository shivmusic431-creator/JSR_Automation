name: YT-AutoPilot - Video Production Pipeline

on:
  repository_dispatch:
    types: [trigger-production]
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Run ID'
        required: true
      main_category:
        description: 'Main Category'
        required: true
      sub_category:
        description: 'Sub Category'
        required: true
      episode:
        description: 'Episode Number'
        required: true
      channel_id:
        description: 'YouTube Channel ID for Upload'
        required: true
        default: 'UCxxxxxxxxxxxxxxxxxxxxxxxxxx'
      is_retry:
        description: 'Is Retry'
        default: 'false'
      attempt:
        description: 'Attempt Number'
        default: '1'

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'
  COQUI_TOS_AGREED: '1'
  RUN_ID: ${{ github.event.inputs.run_id || github.event.client_payload.run_id }}
  MAIN_CATEGORY: ${{ github.event.inputs.main_category || github.event.client_payload.main_category }}
  SUB_CATEGORY: ${{ github.event.inputs.sub_category || github.event.client_payload.sub_category }}
  EPISODE: ${{ github.event.inputs.episode || github.event.client_payload.episode }}
  CHANNEL_ID: ${{ github.event.inputs.channel_id || github.event.client_payload.channel_id }}
  IS_RETRY: ${{ github.event.inputs.is_retry || github.event.client_payload.is_retry || 'false' }}
  ATTEMPT: ${{ github.event.inputs.attempt || github.event.client_payload.attempt || '1' }}
  TIER1_WEBHOOK_URL: ${{ secrets.TIER1_WEBHOOK_URL }}
  TIER1_HEALTH_URL: ${{ secrets.TIER1_HEALTH_URL }}

jobs:
  # Phase 1: Long Script Generation
  generate-script-long:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    outputs:
      script_data: ${{ steps.script.outputs.script_data }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          pip install -r src/video_generation/requirements.txt

      - name: Generate Long Script
        id: script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python src/video_generation/generate_script.py \
            --category "$MAIN_CATEGORY" \
            --sub-category "$SUB_CATEGORY" \
            --episode "$EPISODE" \
            --run-id "$RUN_ID" \
            --video-type long

      - name: Generate Title
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python src/prompts/generate_title.py \
            --script-file output/script_long.json \
            --run-id "$RUN_ID"

      - name: Generate Description
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python src/prompts/generate_description.py \
            --script-file output/script_long.json \
            --run-id "$RUN_ID"

      - name: Generate Thumbnail Concept
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python src/prompts/generate_thumbnail_concept.py \
            --script-file output/script_long.json \
            --run-id "$RUN_ID"

      - name: Upload Long Script Artifact
        uses: actions/upload-artifact@v4
        with:
          name: script-long-${{ env.RUN_ID }}
          path: output/script_long.json
          retention-days: 1

      - name: Notify Tier 1
        if: always()
        env:
          TIER1_WEBHOOK_URL: ${{ secrets.TIER1_WEBHOOK_URL }}
          TIER1_HEALTH_URL: ${{ secrets.TIER1_HEALTH_URL }}
        run: |
          python src/video_generation/notify_webhook.py \
            --action "long_script_generated" \
            --run-id "$RUN_ID" \
            --status "${{ job.status }}"

  # Phase 1.5: Short Script Generation (COMPLETELY SEPARATE)
  generate-script-short:
    runs-on: ubuntu-latest
    needs: generate-script-long
    timeout-minutes: 10
    outputs:
      script_data: ${{ steps.script.outputs.script_data }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          pip install -r src/video_generation/requirements.txt

      - name: Generate Short Script
        id: script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python src/video_generation/generate_script.py \
            --category "$MAIN_CATEGORY" \
            --sub-category "$SUB_CATEGORY" \
            --episode "$EPISODE" \
            --run-id "$RUN_ID" \
            --video-type short

      - name: Upload Short Script Artifact
        uses: actions/upload-artifact@v4
        with:
          name: script-short-${{ env.RUN_ID }}
          path: output/script_short.json
          retention-days: 1

      - name: Notify Tier 1
        if: always()
        env:
          TIER1_WEBHOOK_URL: ${{ secrets.TIER1_WEBHOOK_URL }}
          TIER1_HEALTH_URL: ${{ secrets.TIER1_HEALTH_URL }}
        run: |
          python src/video_generation/notify_webhook.py \
            --action "short_script_generated" \
            --run-id "$RUN_ID" \
            --status "${{ job.status }}"

  # Phase 2: Long Audio Generation with XTTS v2
  generate-audio-long:
    runs-on: ubuntu-latest
    needs: generate-script-long
    timeout-minutes: 360
    outputs:
      audio_duration: ${{ steps.audio.outputs.duration }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install Dependencies
        run: |
          pip install -r src/video_generation/requirements.txt

      - name: Cache XTTS v2 Model
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/tts
            ~/.cache/tts
          key: xtts-v2-model-cache-v1
          restore-keys: |
            xtts-v2-model-cache-

      - name: Install XTTS compatible dependencies
        run: |
          pip uninstall -y torch torchvision torchaudio transformers TTS || true
          pip install torch==2.4.1 torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
          pip install transformers==4.41.2
          pip install TTS
          
      - name: Verify Installation
        run: |
          python -c "import torch; print(f'‚úÖ PyTorch {torch.__version__}')"
          python -c "from TTS.api import TTS; print('‚úÖ XTTS imported successfully')"
          python -c "print('‚úÖ XTTS v2 ready')"

      - name: Download Long Script Artifact
        uses: actions/download-artifact@v4
        with:
          name: script-long-${{ env.RUN_ID }}
          path: output/

      - name: Generate Long Audio with XTTS v2
        id: audio
        run: |
          python src/video_generation/generate_audio.py \
            --script-file output/script_long.json \
            --run-id "$RUN_ID" \
            --script-type long

      - name: Validate Long Audio Duration
        run: |
          python src/video_generation/validate_duration.py \
            --audio-file output/audio_long.wav \
            --min-duration 600 \
            --run-id "$RUN_ID"

      - name: Upload Long Audio Artifact
        uses: actions/upload-artifact@v4
        with:
          name: audio-long-${{ env.RUN_ID }}
          path: output/audio_long.wav
          retention-days: 1

      - name: Notify Tier 1
        if: always()
        env:
          TIER1_WEBHOOK_URL: ${{ secrets.TIER1_WEBHOOK_URL }}
          TIER1_HEALTH_URL: ${{ secrets.TIER1_HEALTH_URL }}
        run: |
          python src/video_generation/notify_webhook.py \
            --action "long_audio_generated" \
            --run-id "$RUN_ID" \
            --status "${{ job.status }}"

  # Phase 2.5: Short Audio Generation with XTTS v2 (COMPLETELY SEPARATE)
  generate-audio-short:
    runs-on: ubuntu-latest
    needs: generate-script-short
    timeout-minutes: 30
    outputs:
      audio_duration: ${{ steps.audio.outputs.duration }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install Dependencies
        run: |
          pip install -r src/video_generation/requirements.txt

      - name: Cache XTTS v2 Model (reuse from long)
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/tts
            ~/.cache/tts
          key: xtts-v2-model-cache-v1
          restore-keys: |
            xtts-v2-model-cache-

      - name: Install XTTS compatible dependencies
        run: |
          pip uninstall -y torch torchvision torchaudio transformers TTS || true
          pip install torch==2.4.1 torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
          pip install transformers==4.41.2
          pip install TTS

      - name: Download Short Script Artifact
        uses: actions/download-artifact@v4
        with:
          name: script-short-${{ env.RUN_ID }}
          path: output/

      - name: Generate Short Audio with XTTS v2
        id: audio
        run: |
          python src/video_generation/generate_audio.py \
            --script-file output/script_short.json \
            --run-id "$RUN_ID" \
            --script-type short

      - name: Validate Short Audio Duration
        run: |
          python src/video_generation/validate_duration.py \
            --audio-file output/audio_short.wav \
            --max-duration 65 \
            --run-id "$RUN_ID"

      - name: Upload Short Audio Artifact
        uses: actions/upload-artifact@v4
        with:
          name: audio-short-${{ env.RUN_ID }}
          path: output/audio_short.wav
          retention-days: 1

      - name: Notify Tier 1
        if: always()
        env:
          TIER1_WEBHOOK_URL: ${{ secrets.TIER1_WEBHOOK_URL }}
          TIER1_HEALTH_URL: ${{ secrets.TIER1_HEALTH_URL }}
        run: |
          python src/video_generation/notify_webhook.py \
            --action "short_audio_generated" \
            --run-id "$RUN_ID" \
            --status "${{ job.status }}"

  # Phase 3: Subtitle Generation (USES AUDIO DURATION AUTHORITY)
  generate-subtitles:
    runs-on: ubuntu-latest
    needs: [generate-audio-long, generate-audio-short]
    timeout-minutes: 30
    strategy:
      matrix:
        audio-type: [long, short]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg fonts-noto fonts-noto-core fonts-noto-extra fonts-noto-ui-core fonts-noto-ui-extra

      - name: Install Python Dependencies
        run: |
          pip install -r src/video_generation/requirements.txt

      - name: Download ${{ matrix.audio-type }} Audio Artifact
        uses: actions/download-artifact@v4
        with:
          name: audio-${{ matrix.audio-type }}-${{ env.RUN_ID }}
          path: output/

      - name: Download ${{ matrix.audio-type }} Script Artifact
        uses: actions/download-artifact@v4
        with:
          name: script-${{ matrix.audio-type }}-${{ env.RUN_ID }}
          path: output/

      - name: Generate ${{ matrix.audio-type }} Subtitles (USING AUDIO DURATION AUTHORITY)
        env:
          RUN_ID: ${{ env.RUN_ID }}
        run: |
          if [ "${{ matrix.audio-type }}" == "long" ]; then
            SCRIPT_FILE="output/script_long.json"
          else
            SCRIPT_FILE="output/script_short.json"
          fi
          
          echo "‚ö° Generating ${{ matrix.audio-type }} subtitles using AUDIO DURATION AUTHORITY"
          python src/video_generation/generate_subtitles.py \
            --run-id "$RUN_ID" \
            --audio-dir output \
            --script-file "$SCRIPT_FILE" \
            --output-file output/subtitles.srt

      - name: Validate ${{ matrix.audio-type }} Subtitles
        run: |
          if [ ! -f "output/subtitles.srt" ]; then
            echo "‚ùå Subtitles file not found"
            exit 1
          fi
          
          LINE_COUNT=$(wc -l < output/subtitles.srt)
          SUB_COUNT=$((LINE_COUNT / 4))
          echo "‚úÖ ${{ matrix.audio-type }} subtitles generated: $SUB_COUNT subtitles"
          
          # Check for center alignment marker
          if grep -q "{\\\\an5}" output/subtitles.srt; then
            echo "‚úÖ Center alignment marker {\\an5} found"
          else
            echo "‚ùå Center alignment marker missing - this is required"
            exit 1
          fi

      - name: Upload ${{ matrix.audio-type }} Subtitles Artifact
        uses: actions/upload-artifact@v4
        with:
          name: subtitles-${{ matrix.audio-type }}-${{ env.RUN_ID }}
          path: output/subtitles.srt
          retention-days: 1

  # Phase 4: Asset Acquisition for Long Video - PRODUCTION MODE
  acquire-assets-long:
    runs-on: ubuntu-latest
    needs: [generate-audio-long, generate-subtitles]
    timeout-minutes: 360
    outputs:
      clip_count: ${{ steps.assets.outputs.clip_count }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup FFmpeg
        uses: FedericoCarboni/setup-ffmpeg@v3
        with:
          ffmpeg-version: '6.1'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          pip install -r src/video_generation/requirements.txt

      - name: Download Long Script & Audio
        uses: actions/download-artifact@v4
        with:
          name: script-long-${{ env.RUN_ID }}
          path: output/
      - uses: actions/download-artifact@v4
        with:
          name: audio-long-${{ env.RUN_ID }}
          path: output/

      - name: Download Stock Footage for Long Video - PRODUCTION MODE
        id: assets
        env:
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
        run: |
          python src/video_generation/acquire_assets.py \
            --script-file output/script_long.json \
            --run-id "$RUN_ID" \
            --video-type long

      - name: Upload Long Assets Artifact
        uses: actions/upload-artifact@v4
        with:
          name: assets-long-${{ env.RUN_ID }}
          path: output/clips/
          retention-days: 1

      - name: Notify Tier 1
        if: always()
        env:
          TIER1_WEBHOOK_URL: ${{ secrets.TIER1_WEBHOOK_URL }}
          TIER1_HEALTH_URL: ${{ secrets.TIER1_HEALTH_URL }}
        run: |
          python src/video_generation/notify_webhook.py \
            --action "assets_downloaded" \
            --run-id "$RUN_ID" \
            --status "${{ job.status }}" \
            --video-type "long"

  # Phase 4.5: Asset Acquisition for Short Video - PRODUCTION MODE
  acquire-assets-short:
    runs-on: ubuntu-latest
    needs: [generate-audio-short, generate-subtitles]
    timeout-minutes: 60
    outputs:
      clip_count: ${{ steps.assets.outputs.clip_count }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup FFmpeg
        uses: FedericoCarboni/setup-ffmpeg@v3
        with:
          ffmpeg-version: '6.1'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          pip install -r src/video_generation/requirements.txt

      - name: Download Short Script & Audio
        uses: actions/download-artifact@v4
        with:
          name: script-short-${{ env.RUN_ID }}
          path: output/
      - uses: actions/download-artifact@v4
        with:
          name: audio-short-${{ env.RUN_ID }}
          path: output/

      - name: Download Stock Footage for Short Video - PRODUCTION MODE
        id: assets
        env:
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
        run: |
          python src/video_generation/acquire_assets.py \
            --script-file output/script_short.json \
            --run-id "$RUN_ID" \
            --video-type short

      - name: Upload Short Assets Artifact
        uses: actions/upload-artifact@v4
        with:
          name: assets-short-${{ env.RUN_ID }}
          path: output/clips/
          retention-days: 1

      - name: Notify Tier 1
        if: always()
        env:
          TIER1_WEBHOOK_URL: ${{ secrets.TIER1_WEBHOOK_URL }}
          TIER1_HEALTH_URL: ${{ secrets.TIER1_HEALTH_URL }}
        run: |
          python src/video_generation/notify_webhook.py \
            --action "assets_downloaded" \
            --run-id "$RUN_ID" \
            --status "${{ job.status }}" \
            --video-type "short"

  # Phase 5: Thumbnail Generation
  generate-thumbnail:
    runs-on: ubuntu-latest
    needs: generate-script-long
    timeout-minutes: 360
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          pip install -r src/video_generation/requirements.txt

      - name: Download Long Script
        uses: actions/download-artifact@v4
        with:
          name: script-long-${{ env.RUN_ID }}
          path: output/

      - name: Generate Thumbnail
        env:
          STABILITY_API_KEY: ${{ secrets.STABILITY_API_KEY }}
        run: |
          python src/video_generation/generate_thumbnail.py \
            --script-file output/script_long.json \
            --run-id "$RUN_ID"

      - name: Upload Thumbnail Artifact
        uses: actions/upload-artifact@v4
        with:
          name: thumbnail-${{ env.RUN_ID }}
          path: output/thumbnail*.jpg
          retention-days: 1

      - name: Notify Tier 1
        if: always()
        env:
          TIER1_WEBHOOK_URL: ${{ secrets.TIER1_WEBHOOK_URL }}
          TIER1_HEALTH_URL: ${{ secrets.TIER1_HEALTH_URL }}
        run: |
          python src/video_generation/notify_webhook.py \
            --action "thumbnail_generated" \
            --run-id "$RUN_ID" \
            --status "${{ job.status }}"

  # Phase 6: Video Editing (Long) with Subtitles
  edit-video-long:
    runs-on: ubuntu-latest
    needs: [generate-audio-long, acquire-assets-long, generate-subtitles]
    timeout-minutes: 360
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup FFmpeg
        uses: FedericoCarboni/setup-ffmpeg@v3
        with:
          ffmpeg-version: '6.1'

      - name: Install Hindi Fonts
        run: |
          sudo apt update
          sudo apt install -y fonts-noto fonts-noto-core fonts-noto-extra fonts-noto-ui-core fonts-noto-ui-extra
          fc-cache -fv
          echo "‚úÖ Noto Sans Devanagari fonts installed for Hindi subtitle support"
          # CRITICAL FIX: Copy the font to assets/fonts so edit_video.py can use
          # fontsdir parameter with libass - avoids /usr/share/fonts permission errors
          mkdir -p assets/fonts
          FONT_SRC=$(fc-list | grep -i "NotoSansDevanagari-Regular" | head -1 | cut -d: -f1)
          if [ -n "$FONT_SRC" ]; then
            cp "$FONT_SRC" assets/fonts/NotoSansDevanagari-Regular.ttf
            echo "‚úÖ Font copied to assets/fonts/: $FONT_SRC"
          else
            # Fallback: find any NotoSansDevanagari font
            FONT_SRC=$(find /usr/share/fonts -name "*NotoSansDevanagari*Regular*" 2>/dev/null | head -1)
            if [ -n "$FONT_SRC" ]; then
              cp "$FONT_SRC" assets/fonts/NotoSansDevanagari-Regular.ttf
              echo "‚úÖ Font copied (fallback): $FONT_SRC"
            else
              echo "‚ö†Ô∏è NotoSansDevanagari-Regular not found, will use system font fallback"
            fi
          fi
        uses: actions/download-artifact@v4
        with:
          name: script-long-${{ env.RUN_ID }}
          path: output/

      - name: Download Long Audio Artifact
        uses: actions/download-artifact@v4
        with:
          name: audio-long-${{ env.RUN_ID }}
          path: output/

      - name: Download Long Assets Artifact
        uses: actions/download-artifact@v4
        with:
          name: assets-long-${{ env.RUN_ID }}
          path: output/clips/

      - name: Download Long Subtitles Artifact
        uses: actions/download-artifact@v4
        with:
          name: subtitles-long-${{ env.RUN_ID }}
          path: output/

      - name: Pipeline Integrity Guard - Long Video
        run: |
          echo "üîç Validating all required files for long video pipeline..."
          MISSING=0
          
          if [ ! -f "output/script_long.json" ]; then
            echo "‚ùå Missing: output/script_long.json"
            MISSING=$((MISSING+1))
          else
            echo "‚úÖ Found: output/script_long.json"
          fi
          
          if [ ! -f "output/audio_long.wav" ]; then
            echo "‚ùå Missing: output/audio_long.wav"
            MISSING=$((MISSING+1))
          else
            echo "‚úÖ Found: output/audio_long.wav"
          fi
          
          if [ ! -f "output/subtitles.srt" ]; then
            echo "‚ùå Missing: output/subtitles.srt"
            MISSING=$((MISSING+1))
          else
            echo "‚úÖ Found: output/subtitles.srt"
          fi
          
          if [ ! -d "output/clips" ] || [ -z "$(ls -A output/clips)" ]; then
            echo "‚ùå Missing: output/clips/ (empty or not found)"
            MISSING=$((MISSING+1))
          else
            echo "‚úÖ Found: output/clips/ with $(ls -1 output/clips | wc -l) files"
          fi
          
          if [ $MISSING -gt 0 ]; then
            echo "‚ùå Pipeline integrity check failed: $MISSING required files missing"
            exit 1
          fi
          
          echo "‚úÖ All required files present - proceeding with long video editing"

      - name: Organize Long Video Files
        run: |
          mkdir -p output/final
          echo "üìÅ Long video files organized:"
          ls -la output/

      - name: Edit Long Video with Subtitles
        run: |
          python src/video_generation/edit_video.py \
            --type long \
            --script-file output/script_long.json \
            --clips-dir output/clips/ \
            --subtitles-file output/subtitles.srt \
            --run-id "$RUN_ID" \
            --audio-file output/audio_long.wav

      - name: Quality Check Long Video
        run: |
          python src/video_generation/quality_check.py \
            --video output/final_video_long.mp4 \
            --type long

      - name: Upload Long Video
        uses: actions/upload-artifact@v4
        with:
          name: video-long-${{ env.RUN_ID }}
          path: output/final_video_long.mp4
          retention-days: 1

      - name: Notify Tier 1
        if: always()
        env:
          TIER1_WEBHOOK_URL: ${{ secrets.TIER1_WEBHOOK_URL }}
          TIER1_HEALTH_URL: ${{ secrets.TIER1_HEALTH_URL }}
        run: |
          python src/video_generation/notify_webhook.py \
            --action "video_rendered" \
            --run-id "$RUN_ID" \
            --status "${{ job.status }}" \
            --video-type "long"

  # Phase 6.5: Video Editing (Short) with Viral Hooks and Subtitles
  edit-video-short:
    runs-on: ubuntu-latest
    needs: [generate-audio-short, acquire-assets-short, generate-subtitles]
    timeout-minutes: 60
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          pip install -r src/video_generation/requirements.txt

      - name: Setup FFmpeg
        uses: FedericoCarboni/setup-ffmpeg@v3
        with:
          ffmpeg-version: '6.1'

      - name: Install Hindi Fonts
        run: |
          sudo apt update
          sudo apt install -y fonts-noto fonts-noto-core fonts-noto-extra fonts-noto-ui-core fonts-noto-ui-extra
          fc-cache -fv
          echo "‚úÖ Noto Sans Devanagari fonts installed for Hindi subtitle support"
          # CRITICAL FIX: Copy font to assets/fonts for libass fontsdir usage
          mkdir -p assets/fonts
          FONT_SRC=$(fc-list | grep -i "NotoSansDevanagari-Regular" | head -1 | cut -d: -f1)
          if [ -n "$FONT_SRC" ]; then
            cp "$FONT_SRC" assets/fonts/NotoSansDevanagari-Regular.ttf
            echo "‚úÖ Font copied to assets/fonts/: $FONT_SRC"
          else
            FONT_SRC=$(find /usr/share/fonts -name "*NotoSansDevanagari*Regular*" 2>/dev/null | head -1)
            if [ -n "$FONT_SRC" ]; then
              cp "$FONT_SRC" assets/fonts/NotoSansDevanagari-Regular.ttf
              echo "‚úÖ Font copied (fallback): $FONT_SRC"
            else
              echo "‚ö†Ô∏è NotoSansDevanagari-Regular not found, will use system font fallback"
            fi
          fi

      - name: Download Short Script Artifact
        uses: actions/download-artifact@v4
        with:
          name: script-short-${{ env.RUN_ID }}
          path: output/

      - name: Download Short Audio Artifact
        uses: actions/download-artifact@v4
        with:
          name: audio-short-${{ env.RUN_ID }}
          path: output/

      - name: Download Short Assets Artifact
        uses: actions/download-artifact@v4
        with:
          name: assets-short-${{ env.RUN_ID }}
          path: output/clips/

      - name: Download Short Subtitles Artifact
        uses: actions/download-artifact@v4
        with:
          name: subtitles-short-${{ env.RUN_ID }}
          path: output/

      - name: Pipeline Integrity Guard - Short Video
        run: |
          echo "üîç Validating all required files for short video pipeline..."
          MISSING=0
          
          if [ ! -f "output/script_short.json" ]; then
            echo "‚ùå Missing: output/script_short.json"
            MISSING=$((MISSING+1))
          else
            echo "‚úÖ Found: output/script_short.json"
          fi
          
          if [ ! -f "output/audio_short.wav" ]; then
            echo "‚ùå Missing: output/audio_short.wav"
            MISSING=$((MISSING+1))
          else
            echo "‚úÖ Found: output/audio_short.wav"
          fi
          
          if [ ! -f "output/subtitles.srt" ]; then
            echo "‚ùå Missing: output/subtitles.srt"
            MISSING=$((MISSING+1))
          else
            echo "‚úÖ Found: output/subtitles.srt"
          fi
          
          if [ ! -d "output/clips" ] || [ -z "$(ls -A output/clips)" ]; then
            echo "‚ùå Missing: output/clips/ (empty or not found)"
            MISSING=$((MISSING+1))
          else
            echo "‚úÖ Found: output/clips/ with $(ls -1 output/clips | wc -l) files"
          fi
          
          if [ $MISSING -gt 0 ]; then
            echo "‚ùå Pipeline integrity check failed: $MISSING required files missing"
            exit 1
          fi
          
          echo "‚úÖ All required files present - proceeding with short video editing"

      - name: Organize Short Video Files
        run: |
          mkdir -p output/final
          echo "üìÅ Short video files organized:"
          ls -la output/

      - name: Generate Viral Hook
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python src/shorts/hook_generator.py \
            --script-file output/script_short.json \
            --run-id "$RUN_ID"

      - name: Generate CTA
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python src/shorts/cta_generator.py \
            --script-file output/script_short.json \
            --run-id "$RUN_ID"

      - name: Edit Short Video with Hook Overlay and Subtitles
        run: |
          python src/video_generation/edit_video.py \
            --type short \
            --script-file output/script_short.json \
            --clips-dir output/clips/ \
            --subtitles-file output/subtitles.srt \
            --run-id "$RUN_ID" \
            --hook-file output/hook.json \
            --cta-file output/cta.json \
            --audio-file output/audio_short.wav

      - name: Quality Check Short Video
        run: |
          python src/video_generation/quality_check.py \
            --video output/final_video_short.mp4 \
            --type short

      - name: Upload Short Video
        uses: actions/upload-artifact@v4
        with:
          name: video-short-${{ env.RUN_ID }}
          path: output/final_video_short.mp4
          retention-days: 1

      - name: Notify Tier 1
        if: always()
        env:
          TIER1_WEBHOOK_URL: ${{ secrets.TIER1_WEBHOOK_URL }}
          TIER1_HEALTH_URL: ${{ secrets.TIER1_HEALTH_URL }}
        run: |
          python src/video_generation/notify_webhook.py \
            --action "video_rendered" \
            --run-id "$RUN_ID" \
            --status "${{ job.status }}" \
            --video-type "short"

  # Phase 7: Direct YouTube Upload
  upload-to-youtube:
    runs-on: ubuntu-latest
    needs: [edit-video-long, edit-video-short, generate-thumbnail]
    timeout-minutes: 360
    outputs:
      long_video_id: ${{ steps.upload.outputs.long_video_id }}
      short_video_id: ${{ steps.upload.outputs.short_video_id }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          pip install -r src/video_generation/requirements.txt
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client firebase-admin pytz

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: output/
          pattern: '*-${{ env.RUN_ID }}'

      - name: Organize Files for Upload
        run: |
          mkdir -p output/upload
          
          # Copy long video
          if [ -d "output/video-long-${{ env.RUN_ID }}" ]; then
            cp output/video-long-${{ env.RUN_ID }}/final_video_long.mp4 output/upload/long_video.mp4 2>/dev/null || echo "‚ö†Ô∏è Long video not found"
          fi
          
          # Copy short video
          if [ -d "output/video-short-${{ env.RUN_ID }}" ]; then
            cp output/video-short-${{ env.RUN_ID }}/final_video_short.mp4 output/upload/short_video.mp4 2>/dev/null || echo "‚ö†Ô∏è Short video not found"
          fi
          
          # Copy thumbnail
          if [ -d "output/thumbnail-${{ env.RUN_ID }}" ]; then
            cp output/thumbnail-${{ env.RUN_ID }}/thumbnail*.jpg output/upload/thumbnail.jpg 2>/dev/null || echo "‚ö†Ô∏è Thumbnail not found"
          fi
          
          # Copy long script (contains titles, descriptions)
          if [ -d "output/script-long-${{ env.RUN_ID }}" ]; then
            cp output/script-long-${{ env.RUN_ID }}/script_long.json output/upload/script.json 2>/dev/null || echo "‚ö†Ô∏è Script not found"
          fi
          
          echo "üìÅ Files ready for YouTube upload:"
          ls -la output/upload/

      - name: Verify Upload Files
        run: |
          REQUIRED_FILES=("long_video.mp4" "short_video.mp4" "script.json")
          MISSING_FILES=0
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "output/upload/$file" ]; then
              echo "‚ùå Missing required file: $file"
              MISSING_FILES=$((MISSING_FILES + 1))
            else
              echo "‚úÖ Found: $file ($(du -h output/upload/$file | cut -f1))"
            fi
          done
          
          if [ $MISSING_FILES -gt 0 ]; then
            echo "‚ùå Cannot proceed: $MISSING_FILES required files missing"
            exit 1
          fi
          
          echo "‚úÖ All required files present"

      - name: Upload to YouTube
        id: upload
        env:
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          RUN_ID: ${{ env.RUN_ID }}
          CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
        run: |
          python src/youtube/upload_to_youtube.py \
            --channel-id "${{ env.CHANNEL_ID }}" \
            --files-dir output/upload/
          
          # Extract video IDs from manifest
          if [ -f "output/upload/youtube_manifest.json" ]; then
            LONG_VIDEO_ID=$(jq -r '.long_video_id' output/upload/youtube_manifest.json)
            SHORT_VIDEO_ID=$(jq -r '.short_video_id' output/upload/youtube_manifest.json)
            
            echo "long_video_id=$LONG_VIDEO_ID" >> $GITHUB_OUTPUT
            echo "short_video_id=$SHORT_VIDEO_ID" >> $GITHUB_OUTPUT
            
            echo "‚úÖ Long Video ID: $LONG_VIDEO_ID"
            echo "‚úÖ Short Video ID: $SHORT_VIDEO_ID"
          fi

      - name: Notify Tier 1 - YouTube Upload Complete
        env:
          TIER1_WEBHOOK_URL: ${{ secrets.TIER1_WEBHOOK_URL }}
          TIER1_HEALTH_URL: ${{ secrets.TIER1_HEALTH_URL }}
        run: |
          python src/video_generation/notify_webhook.py \
            --action "youtube_upload_complete" \
            --run-id "$RUN_ID" \
            --status "success" \
            --long-video-id "${{ steps.upload.outputs.long_video_id }}" \
            --short-video-id "${{ steps.upload.outputs.short_video_id }}"

  # Phase 8: Final Success Webhook
  notify-success:
    runs-on: ubuntu-latest
    needs: [upload-to-youtube]
    if: success()
    steps:
      - name: Notify Complete Success
        env:
          TIER1_WEBHOOK_URL: ${{ secrets.TIER1_WEBHOOK_URL }}
          TIER1_HEALTH_URL: ${{ secrets.TIER1_HEALTH_URL }}
        run: |
          python src/video_generation/notify_webhook.py \
            --action "pipeline_complete" \
            --run-id "$RUN_ID" \
            --status "success" \
            --long-video-id "${{ needs.upload-to-youtube.outputs.long_video_id }}" \
            --short-video-id "${{ needs.upload-to-youtube.outputs.short_video_id }}"
          
          echo "‚úÖ Pipeline completed successfully!"
          echo "üìπ Long Video: https://youtube.com/watch?v=${{ needs.upload-to-youtube.outputs.long_video_id }}"
          echo "üì± Short Video: https://youtube.com/watch?v=${{ needs.upload-to-youtube.outputs.short_video_id }}"

  # Phase 9: Cleanup
  cleanup:
    runs-on: ubuntu-latest
    needs: [upload-to-youtube, notify-success]
    if: always()
    steps:
      - name: Cleanup Artifacts
        uses: geekyeggo/delete-artifact@v4
        with:
          name: |
            script-long-${{ env.RUN_ID }}
            script-short-${{ env.RUN_ID }}
            audio-long-${{ env.RUN_ID }}
            audio-short-${{ env.RUN_ID }}
            assets-long-${{ env.RUN_ID }}
            assets-short-${{ env.RUN_ID }}
            thumbnail-${{ env.RUN_ID }}
            subtitles-long-${{ env.RUN_ID }}
            subtitles-short-${{ env.RUN_ID }}
            video-long-${{ env.RUN_ID }}
            video-short-${{ env.RUN_ID }}
          failOnError: false

      - name: Final Status
        run: |
          echo "==================================="
          echo "üìä WORKFLOW SUMMARY"
          echo "==================================="
          echo "Run ID: $RUN_ID"
          echo "Category: $MAIN_CATEGORY / $SUB_CATEGORY"
          echo "Episode: $EPISODE"
          echo "Channel: $CHANNEL_ID"
          echo "Status: ${{ job.status }}"
          echo "==================================="
