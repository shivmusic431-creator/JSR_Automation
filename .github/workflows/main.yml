name: YT-AutoPilot - Viral Shorts Production Pipeline

on:
  repository_dispatch:
    types: [trigger-production]
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Run ID'
        required: true
      main_category:
        description: 'Main Category'
        required: true
      sub_category:
        description: 'Sub Category'
        required: true
      episode:
        description: 'Episode Number'
        required: true
      channel_id:
        description: 'YouTube Channel ID for Upload'
        required: true
      channel_index:
        description: 'Channel Index (for multi-voice selection)'
        required: false
        default: '0'
      is_retry:
        description: 'Is Retry'
        default: 'false'
      attempt:
        description: 'Attempt Number'
        default: '1'

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'
  COQUI_TOS_AGREED: '1'
  RUN_ID: ${{ github.event.inputs.run_id || github.event.client_payload.run_id }}
  MAIN_CATEGORY: ${{ github.event.inputs.main_category || github.event.client_payload.main_category }}
  SUB_CATEGORY: ${{ github.event.inputs.sub_category || github.event.client_payload.sub_category }}
  EPISODE: ${{ github.event.inputs.episode || github.event.client_payload.episode }}
  CHANNEL_ID: ${{ github.event.inputs.channel_id || github.event.client_payload.channel_id }}
  CHANNEL_INDEX: ${{ github.event.inputs.channel_index || github.event.client_payload.channel_index || '0' }}
  IS_RETRY: ${{ github.event.inputs.is_retry || github.event.client_payload.is_retry || 'false' }}
  ATTEMPT: ${{ github.event.inputs.attempt || github.event.client_payload.attempt || '1' }}
  TIER1_WEBHOOK_URL: ${{ secrets.TIER1_WEBHOOK_URL }}
  TIER1_HEALTH_URL: ${{ secrets.TIER1_HEALTH_URL }}

jobs:
  # Phase 1: Viral Shorts Script Generation
  generate-script:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      script_data: ${{ steps.script.outputs.script_data }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          pip install -r src/video_generation/requirements.txt

      - name: Generate Viral Shorts Script
        id: script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python src/video_generation/generate_script.py \
            --category "$MAIN_CATEGORY" \
            --sub-category "$SUB_CATEGORY" \
            --episode "$EPISODE" \
            --run-id "$RUN_ID" \
            --channel-id "$CHANNEL_ID"

      - name: Generate Title
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python src/prompts/generate_title.py \
            --script-file output/script_short.json \
            --run-id "$RUN_ID"

      - name: Generate Description
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python src/prompts/generate_description.py \
            --script-file output/script_short.json \
            --run-id "$RUN_ID"

      - name: Generate Thumbnail Concept
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python src/prompts/generate_thumbnail_concept.py \
            --script-file output/script_short.json \
            --run-id "$RUN_ID"

      - name: Upload Script Artifact
        uses: actions/upload-artifact@v4
        with:
          name: script-${{ env.RUN_ID }}
          path: output/script_short.json
          retention-days: 1

      - name: Notify Tier 1
        if: always()
        env:
          TIER1_WEBHOOK_URL: ${{ secrets.TIER1_WEBHOOK_URL }}
          TIER1_HEALTH_URL: ${{ secrets.TIER1_HEALTH_URL }}
        run: |
          python src/video_generation/notify_webhook.py \
            --action "script_generated" \
            --run-id "$RUN_ID" \
            --status "${{ job.status }}" \
            --channel-id "$CHANNEL_ID"

  # Phase 2: Audio Generation with Multi-Voice Support
  generate-audio:
    runs-on: ubuntu-latest
    needs: generate-script
    timeout-minutes: 60
    outputs:
      audio_duration: ${{ steps.audio.outputs.duration }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install Dependencies
        run: |
          pip install -r src/video_generation/requirements.txt

      - name: Cache XTTS v2 Model
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/tts
            ~/.cache/tts
          key: xtts-v2-model-cache-v1
          restore-keys: |
            xtts-v2-model-cache-

      - name: Install XTTS compatible dependencies
        run: |
          pip uninstall -y torch torchvision torchaudio transformers TTS || true
          pip install torch==2.4.1 torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
          pip install transformers==4.41.2
          pip install TTS
          
      - name: Verify Installation
        run: |
          python -c "import torch; print(f'‚úÖ PyTorch {torch.__version__}')"
          python -c "from TTS.api import TTS; print('‚úÖ XTTS imported successfully')"
          python -c "print('‚úÖ XTTS v2 ready')"

      - name: Download Script Artifact
        uses: actions/download-artifact@v4
        with:
          name: script-${{ env.RUN_ID }}
          path: output/

      - name: Setup Multi-Voice Configuration
        id: voice_setup
        run: |
          CHANNEL_IDX="${{ env.CHANNEL_INDEX }}"
          echo "Channel Index: $CHANNEL_IDX"
          
          # Check for voice files with pattern voice{N}.wav
          VOICE_FILES=()
          for f in voices/voice*.wav; do
            if [ -f "$f" ]; then
              VOICE_FILES+=("$f")
            fi
          done
          
          VOICE_COUNT=${#VOICE_FILES[@]}
          echo "Found $VOICE_COUNT voice files"
          
          if [ $VOICE_COUNT -eq 0 ]; then
            echo "‚ö†Ô∏è No voice files found, using default my_voice.wav"
            echo "voice_file=voices/my_voice.wav" >> $GITHUB_OUTPUT
          else
            # Try to get voice for this channel index
            TARGET_VOICE="voices/voice$((CHANNEL_IDX + 1)).wav"
            
            if [ -f "$TARGET_VOICE" ]; then
              echo "‚úÖ Using voice for channel $CHANNEL_IDX: $TARGET_VOICE"
              echo "voice_file=$TARGET_VOICE" >> $GITHUB_OUTPUT
            else
              # Randomly select from available voices
              RANDOM_INDEX=$((RANDOM % VOICE_COUNT))
              SELECTED_VOICE="${VOICE_FILES[$RANDOM_INDEX]}"
              echo "‚ö†Ô∏è Voice $TARGET_VOICE not found, randomly selected: $SELECTED_VOICE"
              echo "voice_file=$SELECTED_VOICE" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Generate Audio with Multi-Voice Support
        id: audio
        env:
          VOICE_FILE: ${{ steps.voice_setup.outputs.voice_file }}
        run: |
          echo "Using voice file: $VOICE_FILE"
          python src/video_generation/generate_audio.py \
            --script-file output/script_short.json \
            --run-id "$RUN_ID" \
            --script-type short \
            --voice-file "$VOICE_FILE"

      - name: Validate Audio Duration (24-58 seconds)
        run: |
          python src/video_generation/validate_duration.py \
            --audio-file output/audio_short.wav \
            --min-duration 24 \
            --max-duration 58 \
            --run-id "$RUN_ID"

      - name: Upload Audio Artifact
        uses: actions/upload-artifact@v4
        with:
          name: audio-${{ env.RUN_ID }}
          path: output/audio_short.wav
          retention-days: 1

      - name: Notify Tier 1
        if: always()
        env:
          TIER1_WEBHOOK_URL: ${{ secrets.TIER1_WEBHOOK_URL }}
          TIER1_HEALTH_URL: ${{ secrets.TIER1_HEALTH_URL }}
        run: |
          python src/video_generation/notify_webhook.py \
            --action "audio_generated" \
            --run-id "$RUN_ID" \
            --status "${{ job.status }}" \
            --channel-id "$CHANNEL_ID"

  # Phase 3: Subtitle Generation
  generate-subtitles:
    runs-on: ubuntu-latest
    needs: generate-audio
    timeout-minutes: 15
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg fonts-noto fonts-noto-core fonts-noto-extra fonts-noto-ui-core fonts-noto-ui-extra

      - name: Install Python Dependencies
        run: |
          pip install -r src/video_generation/requirements.txt

      - name: Download Audio Artifact
        uses: actions/download-artifact@v4
        with:
          name: audio-${{ env.RUN_ID }}
          path: output/

      - name: Download Script Artifact
        uses: actions/download-artifact@v4
        with:
          name: script-${{ env.RUN_ID }}
          path: output/

      - name: Generate Subtitles
        env:
          RUN_ID: ${{ env.RUN_ID }}
        run: |
          python src/video_generation/generate_subtitles.py \
            --run-id "$RUN_ID" \
            --audio-dir output \
            --script-file output/script_short.json \
            --output-file output/subtitles.srt

      - name: Validate Subtitles
        run: |
          if [ ! -f "output/subtitles.srt" ]; then
            echo "‚ùå Subtitles file not found"
            exit 1
          fi
          
          LINE_COUNT=$(wc -l < output/subtitles.srt)
          SUB_COUNT=$((LINE_COUNT / 4))
          echo "‚úÖ Subtitles generated: $SUB_COUNT subtitles"
          
          if grep -q "{\\an5}" output/subtitles.srt; then
            echo "‚úÖ Center alignment marker found"
          else
            echo "‚ùå Center alignment marker missing"
            exit 1
          fi

      - name: Upload Subtitles Artifact
        uses: actions/upload-artifact@v4
        with:
          name: subtitles-${{ env.RUN_ID }}
          path: output/subtitles.srt
          retention-days: 1

  # Phase 4: Asset Acquisition
  acquire-assets:
    runs-on: ubuntu-latest
    needs: [generate-audio, generate-subtitles]
    timeout-minutes: 30
    outputs:
      clip_count: ${{ steps.assets.outputs.clip_count }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup FFmpeg
        uses: FedericoCarboni/setup-ffmpeg@v3
        with:
          ffmpeg-version: '6.1'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          pip install -r src/video_generation/requirements.txt

      - name: Download Script & Audio
        uses: actions/download-artifact@v4
        with:
          name: script-${{ env.RUN_ID }}
          path: output/
      - uses: actions/download-artifact@v4
        with:
          name: audio-${{ env.RUN_ID }}
          path: output/

      - name: Download Stock Footage
        id: assets
        env:
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
        run: |
          python src/video_generation/acquire_assets.py \
            --script-file output/script_short.json \
            --run-id "$RUN_ID" \
            --video-type short

      - name: Upload Assets Artifact
        uses: actions/upload-artifact@v4
        with:
          name: assets-${{ env.RUN_ID }}
          path: output/clips/
          retention-days: 1

      - name: Notify Tier 1
        if: always()
        env:
          TIER1_WEBHOOK_URL: ${{ secrets.TIER1_WEBHOOK_URL }}
          TIER1_HEALTH_URL: ${{ secrets.TIER1_HEALTH_URL }}
        run: |
          python src/video_generation/notify_webhook.py \
            --action "assets_downloaded" \
            --run-id "$RUN_ID" \
            --status "${{ job.status }}" \
            --channel-id "$CHANNEL_ID"

  # Phase 5: Thumbnail Generation
  generate-thumbnail:
    runs-on: ubuntu-latest
    needs: generate-script
    timeout-minutes: 30
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          pip install -r src/video_generation/requirements.txt

      - name: Download Script
        uses: actions/download-artifact@v4
        with:
          name: script-${{ env.RUN_ID }}
          path: output/

      - name: Generate Thumbnail
        env:
          STABILITY_API_KEY: ${{ secrets.STABILITY_API_KEY }}
        run: |
          python src/video_generation/generate_thumbnail.py \
            --script-file output/script_short.json \
            --run-id "$RUN_ID" \
            --for-shorts true

      - name: Upload Thumbnail Artifact
        uses: actions/upload-artifact@v4
        with:
          name: thumbnail-${{ env.RUN_ID }}
          path: output/thumbnail*.jpg
          retention-days: 1

      - name: Notify Tier 1
        if: always()
        env:
          TIER1_WEBHOOK_URL: ${{ secrets.TIER1_WEBHOOK_URL }}
          TIER1_HEALTH_URL: ${{ secrets.TIER1_HEALTH_URL }}
        run: |
          python src/video_generation/notify_webhook.py \
            --action "thumbnail_generated" \
            --run-id "$RUN_ID" \
            --status "${{ job.status }}" \
            --channel-id "$CHANNEL_ID"

  # Phase 6: Video Editing with Viral Elements
  edit-video:
    runs-on: ubuntu-latest
    needs: [generate-audio, acquire-assets, generate-subtitles, generate-thumbnail]
    timeout-minutes: 30
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          pip install -r src/video_generation/requirements.txt

      - name: Setup FFmpeg
        uses: FedericoCarboni/setup-ffmpeg@v3
        with:
          ffmpeg-version: '6.1'

      - name: Install Hindi Fonts
        run: |
          sudo apt update
          sudo apt install -y fonts-noto fonts-noto-core fonts-noto-extra fonts-noto-ui-core fonts-noto-ui-extra
          fc-cache -fv
          echo "‚úÖ Noto Sans Devanagari fonts installed"
          mkdir -p assets/fonts
          FONT_SRC=$(find /usr/share/fonts -name "*NotoSansDevanagari*Regular*" 2>/dev/null | head -1)
          if [ -n "$FONT_SRC" ]; then
            cp "$FONT_SRC" assets/fonts/NotoSansDevanagari-Regular.ttf
            echo "‚úÖ Font copied to assets/fonts/"
          fi

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: output/
          pattern: '*-${{ env.RUN_ID }}'

      - name: Organize Files
        run: |
          mkdir -p output/final
          # Move files from subdirectories
          if [ -d "output/script-${{ env.RUN_ID }}" ]; then
            cp output/script-${{ env.RUN_ID }}/* output/
          fi
          if [ -d "output/audio-${{ env.RUN_ID }}" ]; then
            cp output/audio-${{ env.RUN_ID }}/* output/
          fi
          if [ -d "output/assets-${{ env.RUN_ID }}" ]; then
            cp -r output/assets-${{ env.RUN_ID }}/* output/clips/ 2>/dev/null || true
          fi
          if [ -d "output/subtitles-${{ env.RUN_ID }}" ]; then
            cp output/subtitles-${{ env.RUN_ID }}/* output/
          fi
          echo "üìÅ Files organized"
          ls -la output/

      - name: Pipeline Integrity Check
        run: |
          echo "üîç Validating required files..."
          MISSING=0
          
          if [ ! -f "output/script_short.json" ]; then
            echo "‚ùå Missing: output/script_short.json"
            MISSING=$((MISSING+1))
          fi
          
          if [ ! -f "output/audio_short.wav" ]; then
            echo "‚ùå Missing: output/audio_short.wav"
            MISSING=$((MISSING+1))
          fi
          
          if [ ! -f "output/subtitles.srt" ]; then
            echo "‚ùå Missing: output/subtitles.srt"
            MISSING=$((MISSING+1))
          fi
          
          if [ $MISSING -gt 0 ]; then
            echo "‚ùå Pipeline integrity check failed"
            exit 1
          fi
          
          echo "‚úÖ All required files present"

      - name: Generate Viral Hook
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python src/shorts/hook_generator.py \
            --script-file output/script_short.json \
            --run-id "$RUN_ID"

      - name: Generate CTA
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python src/shorts/cta_generator.py \
            --script-file output/script_short.json \
            --run-id "$RUN_ID"

      - name: Edit Shorts Video
        run: |
          python src/video_generation/edit_video.py \
            --type short \
            --script-file output/script_short.json \
            --clips-dir output/clips/ \
            --subtitles-file output/subtitles.srt \
            --run-id "$RUN_ID" \
            --hook-file output/hook.json \
            --cta-file output/cta.json \
            --audio-file output/audio_short.wav

      - name: Quality Check
        run: |
          python src/video_generation/quality_check.py \
            --video output/final_video_short.mp4 \
            --type short

      - name: Upload Final Video
        uses: actions/upload-artifact@v4
        with:
          name: video-${{ env.RUN_ID }}
          path: output/final_video_short.mp4
          retention-days: 1

      - name: Notify Tier 1
        if: always()
        env:
          TIER1_WEBHOOK_URL: ${{ secrets.TIER1_WEBHOOK_URL }}
          TIER1_HEALTH_URL: ${{ secrets.TIER1_HEALTH_URL }}
        run: |
          python src/video_generation/notify_webhook.py \
            --action "video_rendered" \
            --run-id "$RUN_ID" \
            --status "${{ job.status }}" \
            --channel-id "$CHANNEL_ID"

  # Phase 7: Direct YouTube Upload (Shorts Only)
  upload-to-youtube:
    runs-on: ubuntu-latest
    needs: edit-video
    timeout-minutes: 60
    outputs:
      video_id: ${{ steps.upload.outputs.video_id }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          pip install -r src/video_generation/requirements.txt
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client firebase-admin pytz

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: output/
          pattern: '*-${{ env.RUN_ID }}'

      - name: Organize Files for Upload
        run: |
          mkdir -p output/upload
          
          # Copy video
          if [ -d "output/video-${{ env.RUN_ID }}" ]; then
            cp output/video-${{ env.RUN_ID }}/final_video_short.mp4 output/upload/short_video.mp4
          fi
          
          # Copy thumbnail
          if [ -d "output/thumbnail-${{ env.RUN_ID }}" ]; then
            cp output/thumbnail-${{ env.RUN_ID }}/thumbnail*.jpg output/upload/thumbnail.jpg
          fi
          
          # Copy script
          if [ -d "output/script-${{ env.RUN_ID }}" ]; then
            cp output/script-${{ env.RUN_ID }}/script_short.json output/upload/script.json
          fi
          
          echo "üìÅ Files ready for upload:"
          ls -la output/upload/

      - name: Verify Upload Files
        run: |
          if [ ! -f "output/upload/short_video.mp4" ]; then
            echo "‚ùå Short video not found"
            exit 1
          fi
          
          if [ ! -f "output/upload/script.json" ]; then
            echo "‚ùå Script not found"
            exit 1
          fi
          
          echo "‚úÖ All required files present"

      - name: Upload to YouTube
        id: upload
        env:
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          RUN_ID: ${{ env.RUN_ID }}
          CHANNEL_ID: ${{ env.CHANNEL_ID }}
        run: |
          python src/youtube/upload_to_youtube.py \
            --channel-id "${{ env.CHANNEL_ID }}" \
            --files-dir output/upload/ \
            --video-type shorts
          
          # Extract video ID from manifest
          if [ -f "output/upload/youtube_manifest.json" ]; then
            VIDEO_ID=$(jq -r '.video_id' output/upload/youtube_manifest.json)
            echo "video_id=$VIDEO_ID" >> $GITHUB_OUTPUT
            echo "‚úÖ Video ID: $VIDEO_ID"
          fi

      - name: Notify Tier 1 - Upload Complete
        if: always()
        env:
          TIER1_WEBHOOK_URL: ${{ secrets.TIER1_WEBHOOK_URL }}
          TIER1_HEALTH_URL: ${{ secrets.TIER1_HEALTH_URL }}
        run: |
          python src/video_generation/notify_webhook.py \
            --action "youtube_upload_complete" \
            --run-id "$RUN_ID" \
            --status "${{ job.status }}" \
            --video-id "${{ steps.upload.outputs.video_id }}" \
            --channel-id "$CHANNEL_ID"

  # Phase 8: Final Success Notification
  notify-success:
    runs-on: ubuntu-latest
    needs: upload-to-youtube
    if: always()
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          pip install -r src/video_generation/requirements.txt

      - name: Final Success Notification
        if: needs.upload-to-youtube.result == 'success'
        env:
          TIER1_WEBHOOK_URL: ${{ secrets.TIER1_WEBHOOK_URL }}
          TIER1_HEALTH_URL: ${{ secrets.TIER1_HEALTH_URL }}
        run: |
          python src/video_generation/notify_webhook.py \
            --action "production_complete" \
            --run-id "$RUN_ID" \
            --status "success" \
            --channel-id "$CHANNEL_ID" \
            --message "Viral Shorts production completed successfully!"

      - name: Failure Notification
        if: needs.upload-to-youtube.result == 'failure'
        env:
          TIER1_WEBHOOK_URL: ${{ secrets.TIER1_WEBHOOK_URL }}
          TIER1_HEALTH_URL: ${{ secrets.TIER1_HEALTH_URL }}
        run: |
          python src/video_generation/notify_webhook.py \
            --action "production_failed" \
            --run-id "$RUN_ID" \
            --status "failure" \
            --channel-id "$CHANNEL_ID" \
            --message "Viral Shorts production failed. Check logs for details."
